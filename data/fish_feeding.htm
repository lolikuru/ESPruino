<!DOCTYPE html>
<html lang="ru">
 <head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/css/style.css">
  <script type="text/javascript" src="/js/jquery-3.2.1.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Управление кормушкой</title>
		 <script>
	var xmlHttp=createXmlHttpObject();
	var switch_pos = [0,0,0,0,0,0,0,0];
	var alarm_on = [,,,,,,,];
	var alarm_state_on = [0,0,0,0,0,0,0,0];
	var set_real_time;

	function createXmlHttpObject(){//создание xml
	 if(window.XMLHttpRequest){
	  xmlHttp=new XMLHttpRequest();
	 }else{
	  xmlHttp=new ActiveXObject('Microsoft.XMLHTTP');
	 }
	 return xmlHttp;
	}
	function load(){//получение xml и парсинг в json
	 if(xmlHttp.readyState==0 || xmlHttp.readyState==4){
	  xmlHttp.open('GET','/configs.json',true);
	  xmlHttp.send(null);
	  xmlHttp.onload = function(e) {
	   jsonResponse=JSON.parse(xmlHttp.response);
	   loadBlock();
	  }
	 }
	}

	function loadBlock(data2) {//замена значений в html
		data2 = JSON.parse(xmlHttp.responseText);
		data = document.getElementsByTagName('body')[0].innerHTML;
		var new_string;
		//console.log(data2);
		for (var key in data2)
			{//console.log(typeof data2[key]);
			if(typeof data2[key] != 'object' && typeof data2[key] != 'number'){//строки
			new_string = data.replace(new RegExp('{{'+key+'}}', 'g'), data2[key]);
			data = new_string;}
			else {if(typeof data2[key] == 'object'){//если это массивы
					for(var item in data2[key]){
							//console.log(data2[key]) // раскоментить для просмотра замены
							//console.log('{{'+key+'_'+item+'}}');
							new_string = data.replace(new RegExp('{{'+key+'_'+item+'}}', 'g'), data2[key][item]);
							data = new_string;
							}
						}//и если просто номера
						if(typeof data2[key] == 'number'){
						new_string = data.replace(new RegExp('{{'+key+'}}', 'g'), data2[key]);
							data = new_string;
						}
				}
			}

		document.getElementsByTagName('body')[0].innerHTML = new_string;
		handleServerResponse();
		load_presset();
		last();
	}

	function load_presset(){
	datas = JSON.parse(xmlHttp.responseText);
	for (var i = 0;i < 8; i++) {
	switch_pos[i] = datas["pin"+i][0];
	alarm_on[i] = datas["pin"+i][0];//время включения
	//console.log(switch_pos[i]);
    //console.log('time to alarm' + alarm_on[i]);
	//alarm_off[i] = datas["pin"+i][3];
	alarm_state_on[i] = datas["pin"+i][1];//вкл выкл
	//alarm_state_off[i] = datas["pin"+i][5];
	if(alarm_state_on[i]=='ON') time_button('',i,'ON');
	//if(datas["pin"+i][5]=='ON') time_button('',i,'OFF');
	}
	}

	function val(id){
	 var v = document.getElementById(id).value;
	 return v;
	}
	function send_request(submit,server){
	 request = new XMLHttpRequest();
	 request.open("GET", server, true);
	 request.send();
	 save_status(submit,request);
	}
	function save_status(submit,request){
	 old_submit = submit.value;
	 request.onreadystatechange = function() {
	  if (request.readyState != 4) return;
	  submit.value = request.responseText;
	  setTimeout(function(){
	   submit.value=old_submit;
	   submit_disabled(false);
	  }, 1000);
	 }
	 submit.value = 'Подождите...';
	 submit_disabled(true);
	}
	function submit_disabled(request){
	 var inputs = document.getElementsByTagName("input");
	 for (var i = 0; i < inputs.length; i++) {
	  if (inputs[i].type === 'submit') {inputs[i].disabled = request;}
	 }
	}
	function toggle(target) {//тогл
	 var curVal = document.getElementById(target).className;
	 document.getElementById(target).className = (curVal === 'hidden') ? 'show' : 'hidden';
	}

	function last(){//показ элементов после загрузки
	//sw_load(document.getElementById("pinload"));
	var page = document.getElementsByClassName("container")[0];
	page.setAttribute("style", "display:block;");
	}

	function hideBox(id) {//сокрытие элементов будильника
	  var hb = document.getElementById(id);
	  if (hb.style.display === "none") {
		hb.style.display = "block";
	  } else {
		hb.style.display = "none";
	    }
	   //var bb = document.getElementById('BackButton');

	   if (id === "MainButton") {
	    if( hb.style.display === "none") {
	     document.getElementById('BackButton').style.display = "block";
	    } else {
	     document.getElementById('BackButton').style.display = "none";
	    }
	   }
	   if (id === "BackButton") {
	     document.getElementById('TimeDateDiv7').style.display = "none";
	     document.getElementById('MainButton').style.display = "block";
	     document.getElementById('Portion').style.display = "none";
	   }
	}

	function real_time(hours,min,sec) {//отсчет времени
   sec=Number(sec)+1;
    if (sec>=60){min=Number(min)+1;sec=0;
	if(min!=0){
	//auto_alarm(hours,min);//проверка алармов
	}
	}
    if (min>=60){
	hours=Number(hours)+1;
	min=0;
	//auto_alarm(hours,min);
	}
    if (hours>=24){hours=0};
    document.getElementById("time").innerHTML = hours+":"+min+":"+sec;
    set_real_time = setTimeout("real_time("+hours+","+min+","+sec+");", 1000);
   }
	function handleServerResponse(){//получение времени
    clearTimeout(set_real_time);
    var res = jsonResponse.time.split(":");
    real_time(hours=res[0],min=res[1],sec=res[2]);
    document.body.style.backgroundColor="rgb("+jsonResponse.rgb+")";
   }

        function load_time(submit){//установка времени
    server = "/Time";
    send_request(submit,server);
    load();
   }

	 function auto_alarm(hour,min){//проверка алармов
	 if(min < 10) min = "0"+min;
	 if(hour < 10) hour = "0"+hour;
	 var time = hour+":"+min;
	 //console.log(hour+":"+min);
		for(var n=0; n<8; n++ ){
		  if(alarm_state_on[n] == "ON"&&alarm_on[n] == time) {
		    console.log(time);
		    //check(n,1);
		  }
		}
	 }


	function check(pin,sw) {//кусок подгрузки параметров on/off
    if(sw==1){
    document.getElementById("switch-radio-on-"+pin).checked = false;
	}
	if(sw==0){
    document.getElementById("switch-radio-on-"+pin).checked = true;
	}
	}

	function feed(submit){
	  server = "/feed";
	  send_request(submit,server);
	}

	function sw_load(submit){//подгрузка параметров on/off выходов при старте и включение faid
	for (var i = 1; i < 8; i++) {
	check(i,switch_pos[i-1]);
	}
    //server = "/pins?pin0="+switch_pos[0]+"&pin1="+switch_pos[1]+"&pin2="+switch_pos[2]+"&pin3="+switch_pos[3]+"&pin4="+switch_pos[4]+"&pin5="+switch_pos[5]+"&pin6="+switch_pos[6];
	//send_request(submit,server);

	}

	function time_button(submit,pin,state){//alarm set

	if(state=='ON'){
	document.getElementById('time_but_on_'+pin).classList.toggle('btn-default');
	document.getElementById('time_but_on_'+pin).classList.toggle('btn-success');

	document.getElementById("timeon_"+pin).disabled = !document.getElementById("timeon_"+pin).disabled;

	if(submit!=''){
	if(alarm_state_on[pin]=="OFF"){
	alarm_state_on[pin] = "ON";
	alarm_on[pin] = val('timeon_'+pin);
	server = "set_alarm?pinout="+pin+"&alarm_state_on=ON&alarm_on="+val('timeon_'+pin);
	} else {
	alarm_state_on[pin] = "OFF";
	server = "set_alarm?pinout="+pin+"&alarm_state_on=OFF";
	}
	send_request(submit,server);
	}
	}
	}
   </script>
</head>
<body onload="load();">
  <div class="container" style="display:none;">
	   <div class="row" style="text-align:center;">
		<h1 style="margin:10px;">Управление кормушкой</h1>
		<h2><span class="label label-info" id="time">{{time}}</span>
		</h2>
			<div class="col-xs-12 col-sm-10 col-md-8 col-sm-offset-1 col-md-offset-2" style="
				padding-left: 0px;
				padding-right: 0px;">
				<a class="btn btn-block btn-danger" href="/">Страница настройки</a>
					<ul class="list-group col-6">
						<li id="devlist" class="list-group-item"">
							<div class="row"  id="MainButton">
								<div class="col-md-4">
									<span class="input-group-btn">
										<button class="btn btn-default" type="button" onclick="feed(this);"><img src="/css/images/fishfeed.png" alt="⬇"></button>
									</span>
									</div>
								<div class="col-md-4">
									<span class="input-group-btn">
								        <button class="btn btn-default" type="button" onclick="hideBox('TimeDateDiv7'); hideBox('MainButton');" autocomplete="off" style="">
											<img src="/css/images/alarm.png" alt="⬇"></button>
									</span>
								</div>
								<div class="col-md-4">
									<span class="input-group-btn">
								        <button class="btn btn-default" type="button" onclick="console.log('preset rotation'); hideBox('Portion');" autocomplete="off" style="">
											<img src="/css/images/kitchen-scale.png" alt="⬇"></button>
									</span>
								</div>
							</div>
						    <div class="row">
								<div class="col-md-4 col-md-offset-4" id="TimeDateDiv7" style="display: none;">
									<div class="text-left" style="width: 115px;">
										<div class="input-group">
											<input type="time" class="form-control col-md-8 col-xs-8 col-sm-8" id="timeon_1" list="time-list" value="{{pin1_0}}" style="height: 22px; font-size: 14px;padding-left: 1px;padding-right: 1px;">
											<div class="input-group-btn">
												<button class="btn btn-default btn-xs" id="time_but_on_1" type="submit" onclick="time_button(this,1,'ON')" style="width: 36px;">ON</button>
											</div>
										</div>
										<div class="input-group">
											<input type="time" class="form-control col-md-8 col-xs-8 col-sm-8" id="timeon_2" list="time-list" value="{{pin2_0}}" style="height: 22px; font-size: 14px;padding-left: 1px;padding-right: 1px;">
											<div class="input-group-btn">
												<button class="btn btn-default btn-xs" id="time_but_on_2" type="submit" onclick="time_button(this,2,'ON')" style="width: 36px;">ON</button>
											</div>
										</div>
										<div class="input-group">
											<input type="time" class="form-control col-md-8 col-xs-8 col-sm-8" id="timeon_3" list="time-list" value="{{pin3_0}}" style="height: 22px; font-size: 14px;padding-left: 1px;padding-right: 1px;">
											<div class="input-group-btn">
												<button class="btn btn-default btn-xs" id="time_but_on_3" type="submit" onclick="time_button(this,3,'ON')" style="width: 36px;">ON</button>
											</div>
										</div>
										<div class="input-group">
											<input type="time" class="form-control col-md-8 col-xs-8 col-sm-8" id="timeon_4" list="time-list" value="{{pin4_0}}" style="height: 22px; font-size: 14px;padding-left: 1px;padding-right: 1px;">
											<div class="input-group-btn">
												<button class="btn btn-default btn-xs" id="time_but_on_4" type="submit" onclick="time_button(this,4,'ON')" style="width: 36px;">ON</button>
											</div>
										</div>
										<div class="input-group">
											<input type="time" class="form-control col-md-8 col-xs-8 col-sm-8" id="timeon_5" list="time-list" value="{{pin5_0}}" style="height: 22px; font-size: 14px;padding-left: 1px;padding-right: 1px;">
											<div class="input-group-btn">
												<button class="btn btn-default btn-xs" id="time_but_on_5" type="submit" onclick="time_button(this,5,'ON')" style="width: 36px;">ON</button>
											</div>
										</div>
										<div class="input-group">
											<input type="time" class="form-control col-md-8 col-xs-8 col-sm-8" id="timeon_6" list="time-list" value="{{pin6_0}}" style="height: 22px; font-size: 14px;padding-left: 1px;padding-right: 1px;">
											<div class="input-group-btn">
												<button class="btn btn-default btn-xs" id="time_but_on_6" type="submit" onclick="time_button(this,6,'ON')" style="width: 36px;">ON</button>
											</div>
										</div>
										<div class="input-group">
											<input type="time" class="form-control col-md-8 col-xs-8 col-sm-8" id="timeon_7" list="time-list" value="{{pin7_0}}" style="height: 22px; font-size: 14px;padding-left: 1px;padding-right: 1px;">
											<div class="input-group-btn">
												<button class="btn btn-default btn-xs" id="time_but_on_7" type="submit" onclick="time_button(this,7,'ON')" style="width: 36px;">ON</button>
										    </div>
										</div>
									</div>
								</div>
								  <div class="col-md-6 col-md-offset-3" id="Portion">
									<div class="input-group">
									  <input type="text" class="form-control" placeholder="Угол поворота 1-360">
									  <span class="input-group-btn">
										<button class="btn btn-default" type="button">Установить</button>
									  </span>
									</div><!-- /input-group -->
								  </div><!-- /.col-lg-6 -->
                                </div><!-- /.row -->
							</div>
						</li>
						<button class="btn btn-block btn-success" id="BackButton" style="display: none;" onclick="hideBox('BackButton');" type="button">Вернуться назад</button>
					</ul>
			</div>
		</div>
	</div>
</body>
<!-- <script type="text/javascript" src="/js/jquery-3.3.1.min.js"></script>
<script>
window.onload = function() {
    alert( 'Документ и все ресурсы загружены' );
  };
  </script> -->
</html>